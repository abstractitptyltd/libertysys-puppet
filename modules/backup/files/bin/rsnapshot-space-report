#!/bin/bash
#
# Author:	Paul Gear
# Created:	2007-10-03
# Modified:	2010-02-04
# Description:	Script to report on disk space used by rsnapshot backups.
#

set -e
set -u

OUTPUT=/var/www/html/rsnapshot-report.html
PATH=$PATH:/usr/local/bin

# Redirect errors to standard output (which will show up in cron),
# and the real output of the script to a file for people to read.

mv -f $OUTPUT $OUTPUT.old
exec 2>&1 >$OUTPUT
chmod 644 $OUTPUT

echo "<html><body>"
for d; do
	cd $d
	echo "<pre>
	`df -h .`
	</pre>"
	# rsnapgraph.conf should be created as a symlink to the appropriate file in /usr/local/etc/
	rsnapgraph -f rsnapgraph.conf >rsnapgraph.out 2>rsnapgraph.err
	du -k --max-depth=2 | rsnapshot-space-report-format $d
done
echo "</body></html>"

